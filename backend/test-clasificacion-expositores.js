const { 
  CategoriaComercial, 
  EtiquetaLibre, 
  EmpresaExpositora, 
  EmpresaCategoria, 
  EmpresaEtiqueta,
  Usuario 
} = require('./src/models');

async function testClasificacionModule() {
  console.log('üß™ INICIANDO PRUEBAS DEL M√ìDULO DE CLASIFICACI√ìN DE EXPOSITORES');
  console.log('='.repeat(70));

  try {
    // ==================== PRUEBAS DE CATEGOR√çAS COMERCIALES ====================
    console.log('\nüìÅ PRUEBAS DE CATEGOR√çAS COMERCIALES');
    console.log('-'.repeat(50));

    // 1. Verificar categor√≠as creadas
    const totalCategorias = await CategoriaComercial.count({ where: { deleted_at: null } });
    console.log(`‚úÖ Total de categor√≠as en el sistema: ${totalCategorias}`);

    // 2. Obtener categor√≠as principales
    const categoriasPrincipales = await CategoriaComercial.findAll({
      where: { 
        id_categoria_padre: null, 
        deleted_at: null, 
        estado: 'activa' 
      },
      order: [['orden_visualizacion', 'ASC']]
    });
    console.log(`‚úÖ Categor√≠as principales encontradas: ${categoriasPrincipales.length}`);
    categoriasPrincipales.forEach(cat => {
      console.log(`   - ${cat.nombre_categoria} (${cat.slug})`);
    });

    // 3. Probar jerarqu√≠a - obtener subcategor√≠as de Tecnolog√≠a
    const tecnologia = await CategoriaComercial.findOne({
      where: { slug: 'tecnologia-e-innovacion' },
      include: [{
        model: CategoriaComercial,
        as: 'subcategorias',
        where: { deleted_at: null, estado: 'activa' },
        required: false
      }]
    });

    if (tecnologia) {
      console.log(`‚úÖ Subcategor√≠as de "${tecnologia.nombre_categoria}": ${tecnologia.subcategorias?.length || 0}`);
      tecnologia.subcategorias?.forEach(sub => {
        console.log(`   - ${sub.nombre_categoria}`);
      });
    }

    // ==================== PRUEBAS DE ETIQUETAS LIBRES ====================
    console.log('\nüè∑Ô∏è  PRUEBAS DE ETIQUETAS LIBRES');
    console.log('-'.repeat(50));

    // 1. Verificar etiquetas creadas
    const totalEtiquetas = await EtiquetaLibre.count({ where: { deleted_at: null } });
    console.log(`‚úÖ Total de etiquetas en el sistema: ${totalEtiquetas}`);

    // 2. Obtener etiquetas por tipo
    const tiposEtiquetas = await EtiquetaLibre.findAll({
      where: { deleted_at: null, estado: 'activa' },
      attributes: [
        'tipo_etiqueta',
        [EtiquetaLibre.sequelize.fn('COUNT', EtiquetaLibre.sequelize.col('id_etiqueta')), 'cantidad']
      ],
      group: ['tipo_etiqueta'],
      raw: true
    });

    console.log('‚úÖ Distribuci√≥n de etiquetas por tipo:');
    tiposEtiquetas.forEach(tipo => {
      console.log(`   - ${tipo.tipo_etiqueta}: ${tipo.cantidad} etiquetas`);
    });

    // 3. Obtener etiquetas destacadas
    const etiquetasDestacadas = await EtiquetaLibre.findAll({
      where: { 
        deleted_at: null, 
        estado: 'activa', 
        es_destacada: true 
      },
      limit: 5
    });
    console.log(`‚úÖ Etiquetas destacadas: ${etiquetasDestacadas.length}`);
    etiquetasDestacadas.forEach(etq => {
      console.log(`   - ${etq.nombre_etiqueta} (${etq.tipo_etiqueta})`);
    });

    // ==================== PRUEBAS DE ASIGNACI√ìN A EMPRESAS ====================
    console.log('\nüè¢ PRUEBAS DE ASIGNACI√ìN A EMPRESAS');
    console.log('-'.repeat(50));

    // 1. Obtener primera empresa aprobada para pruebas
    const empresa = await EmpresaExpositora.findOne({
      where: { 
        deleted_at: null, 
        estado: 'aprobada' 
      },
      order: [['created_at', 'ASC']]
    });

    if (!empresa) {
      console.log('‚ö†Ô∏è  No se encontraron empresas aprobadas para realizar pruebas');
      console.log('   Creando empresa de prueba...');
      
      // Crear empresa de prueba
      const empresaPrueba = await EmpresaExpositora.create({
        nombre_empresa: 'Tech Solutions Demo',
        email_contacto: 'demo@techsolutions.com',
        sector: 'tecnolog√≠a',
        estado: 'aprobada',
        descripcion: 'Empresa de prueba para testing del sistema de clasificaci√≥n'
      });
      
      console.log(`‚úÖ Empresa de prueba creada: ${empresaPrueba.nombre_empresa}`);
      
      // Usar la empresa de prueba
      await testEmpresaClasificacion(empresaPrueba);
    } else {
      console.log(`‚úÖ Usando empresa existente: ${empresa.nombre_empresa}`);
      await testEmpresaClasificacion(empresa);
    }

    // ==================== PRUEBAS DE B√öSQUEDA Y FILTRADO ====================
    console.log('\nüîç PRUEBAS DE B√öSQUEDA Y FILTRADO');
    console.log('-'.repeat(50));

    // 1. Buscar categor√≠as por t√©rmino
    const resultadosBusqueda = await CategoriaComercial.findAll({
      where: {
        deleted_at: null,
        estado: 'activa',
        [CategoriaComercial.sequelize.Op.or]: [
          { nombre_categoria: { [CategoriaComercial.sequelize.Op.like]: '%tecnolog√≠a%' } },
          { palabras_clave: { [CategoriaComercial.sequelize.Op.like]: '%tecnolog√≠a%' } }
        ]
      },
      limit: 3
    });
    console.log(`‚úÖ B√∫squeda por "tecnolog√≠a": ${resultadosBusqueda.length} resultados`);

    // 2. Buscar etiquetas por t√©rmino
    const etiquetasBusqueda = await EtiquetaLibre.findAll({
      where: {
        deleted_at: null,
        estado: 'activa',
        [EtiquetaLibre.sequelize.Op.or]: [
          { nombre_etiqueta: { [EtiquetaLibre.sequelize.Op.like]: '%SaaS%' } },
          { palabras_clave: { [EtiquetaLibre.sequelize.Op.like]: '%software%' } }
        ]
      },
      limit: 3
    });
    console.log(`‚úÖ B√∫squeda de etiquetas por "SaaS/software": ${etiquetasBusqueda.length} resultados`);

    // ==================== ESTAD√çSTICAS GENERALES ====================
    console.log('\nüìä ESTAD√çSTICAS GENERALES DEL SISTEMA');
    console.log('-'.repeat(50));

    const stats = {
      categorias_activas: await CategoriaComercial.count({
        where: { deleted_at: null, estado: 'activa' }
      }),
      categorias_destacadas: await CategoriaComercial.count({
        where: { deleted_at: null, estado: 'activa', es_destacada: true }
      }),
      etiquetas_activas: await EtiquetaLibre.count({
        where: { deleted_at: null, estado: 'activa' }
      }),
      etiquetas_temporales: await EtiquetaLibre.count({
        where: { deleted_at: null, estado: 'activa', es_temporal: true }
      }),
      empresas_clasificadas: await EmpresaCategoria.count({
        where: { deleted_at: null },
        distinct: true,
        col: 'id_empresa'
      }),
      total_asignaciones_categoria: await EmpresaCategoria.count({
        where: { deleted_at: null }
      }),
      total_asignaciones_etiqueta: await EmpresaEtiqueta.count({
        where: { deleted_at: null }
      })
    };

    console.log('üìà M√©tricas del sistema:');
    Object.entries(stats).forEach(([key, value]) => {
      console.log(`   - ${key.replace(/_/g, ' ')}: ${value}`);
    });

    console.log('\nüéâ TODAS LAS PRUEBAS COMPLETADAS EXITOSAMENTE');
    console.log('='.repeat(70));

  } catch (error) {
    console.error('\n‚ùå ERROR EN LAS PRUEBAS:', error.message);
    console.error('Stack trace:', error.stack);
  }
}

async function testEmpresaClasificacion(empresa) {
  console.log(`\nüß™ Probando clasificaci√≥n para: ${empresa.nombre_empresa}`);
  
  try {
    // 1. Asignar categor√≠a principal
    const categoriaTech = await CategoriaComercial.findOne({
      where: { slug: 'tecnologia-e-innovacion' }
    });

    if (categoriaTech) {
      const [asignacionCategoria, creada] = await EmpresaCategoria.findOrCreate({
        where: {
          id_empresa: empresa.id_empresa,
          id_categoria: categoriaTech.id_categoria
        },
        defaults: {
          es_categoria_principal: true,
          prioridad: 1,
          descripcion_actividad: 'Empresa l√≠der en soluciones tecnol√≥gicas',
          estado: 'activa'
        }
      });

      if (creada) {
        console.log(`   ‚úÖ Categor√≠a "${categoriaTech.nombre_categoria}" asignada como principal`);
        
        // Actualizar contadores
        await categoriaTech.updateCounters();
      } else {
        console.log(`   ‚ÑπÔ∏è  Categor√≠a ya estaba asignada`);
      }
    }

    // 2. Asignar etiquetas
    const etiquetasSugeridas = await EtiquetaLibre.findAll({
      where: {
        deleted_at: null,
        estado: 'activa',
        tipo_etiqueta: ['producto', 'tecnologia'],
        es_sugerible: true
      },
      limit: 3
    });

    console.log(`   üè∑Ô∏è  Asignando ${etiquetasSugeridas.length} etiquetas...`);
    
    for (const etiqueta of etiquetasSugeridas) {
      const [asignacionEtiqueta, creada] = await EmpresaEtiqueta.findOrCreate({
        where: {
          id_empresa: empresa.id_empresa,
          id_etiqueta: etiqueta.id_etiqueta
        },
        defaults: {
          relevancia: 4,
          origen_asignacion: 'automatica',
          estado: 'activa'
        }
      });

      if (creada) {
        console.log(`      - ${etiqueta.nombre_etiqueta} (${etiqueta.tipo_etiqueta})`);
        await etiqueta.incrementarUso(empresa.id_empresa);
      }
    }

    // 3. Verificar clasificaci√≥n completa
    const resumen = await empresa.getResumenClasificacion();
    console.log(`   üìä Resumen de clasificaci√≥n:`, resumen);

    // 4. Probar m√©todos de la empresa
    const categoriaPrincipal = await empresa.getCategoriaPrincipal();
    if (categoriaPrincipal) {
      console.log(`   üéØ Categor√≠a principal: ${categoriaPrincipal.categoriaComercial.nombre_categoria}`);
    }

    const estaClasificada = await empresa.estaClasificada();
    console.log(`   ‚úÖ ¬øEst√° clasificada?: ${estaClasificada ? 'S√≠' : 'No'}`);

  } catch (error) {
    console.error(`   ‚ùå Error al probar empresa ${empresa.nombre_empresa}:`, error.message);
  }
}

// Funci√≥n para limpiar datos de prueba (opcional)
async function limpiarDatosPrueba() {
  console.log('\nüßπ LIMPIANDO DATOS DE PRUEBA...');
  
  try {
    // Eliminar empresa de prueba si existe
    const empresaPrueba = await EmpresaExpositora.findOne({
      where: { nombre_empresa: 'Tech Solutions Demo' }
    });

    if (empresaPrueba) {
      await empresaPrueba.softDelete();
      console.log('‚úÖ Empresa de prueba eliminada');
    }

    console.log('‚úÖ Limpieza completada');
  } catch (error) {
    console.error('‚ùå Error en limpieza:', error.message);
  }
}

// Ejecutar si se llama directamente
if (require.main === module) {
  testClasificacionModule()
    .then(() => {
      console.log('\nüéØ Script de pruebas finalizado');
      process.exit(0);
    })
    .catch((error) => {
      console.error('\nüí• Error fatal en el script:', error);
      process.exit(1);
    });
}

module.exports = {
  testClasificacionModule,
  testEmpresaClasificacion,
  limpiarDatosPrueba
};
